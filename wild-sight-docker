#
# Wild-Sight-AI
# Smart Following Camera with Animal Detection
#   for Kria KR260 Board
#
# Created by: Matjaz Zibert S59MZ - August 2025
#
# Dockerfile for final Wild-Sight-AI application Docker image
#   - Based on ros2-humble image
#   - Compiled on Xilinx kria-developer image on Kria board
#
# Design based on Kria KV260 Smartcam Demo App by AMD
#
# Original Smartcam link:
#     https://github.com/Xilinx/smartcam/tree/xlnx_rel_v2022.1
#     https://github.com/Xilinx/kria-docker/tree/xlnx_rel_v2022.1
#
# Hackster.io Project link:
#     https://www.hackster.io/matjaz4
#


## Building based on kria-developer docker image
FROM kria-developer:opencv AS build

WORKDIR /workspace

COPY wild-sight-app wild-sight-app

RUN cd wild-sight-app ;\
    mkdir -p build/install ;\
    cd build ;\
    cmake ../ -DCMAKE_INSTALL_PREFIX:PATH=/ ;\
    make ;\
    make DESTDIR=./install install ;


## Building based on kria-runtime docker image
FROM ros2-humble:opencv

# Copy from kria-developer builded files
COPY --from=build /workspace/wild-sight-app/build/install /

# Logged builded time
ARG BUILD_DATE
LABEL org.label-schema.build-date=$BUILD_DATE

# Install welcome screen
COPY scripts/bashrc /etc/bash.bashrc
RUN chmod a+rwx /etc/bash.bashrc
ADD scripts/welcome.sh /etc/
RUN echo $BUILD_DATE > /etc/BUILD_DATE.txt

# Set working directory
WORKDIR /root/ros2_ws

RUN echo "source /root/ros2_ws/install/setup.bash" >> ~/.bashrc

# Copy custom ROS2 code
COPY ros2_ws/src src

# Build the ROS2 workspace
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && colcon build"

# install application startup script
ADD scripts/run.sh .
ADD scripts/test.sh .
RUN chmod +x run.sh
RUN chmod +x test.sh

